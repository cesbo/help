---
title: "Настройки экспорта потокового EPG"
date: 2023-08-14
---

Настройка экспорта EPG для извлечения электронного гида из потока

![Параметры экспорта потокового EPG](https://cdn.cesbo.com/help/astra/admin-guide/stream/epg.png)

- `XMLTV Channel ID` - использовать пользовательский ID канала вместо основного ID
- `Format` - Формат экспорта EPG:
    - `XMLTV` - этот популярный формат используется для хранения и распространения EPG. XMLTV совместим с различными промежуточными программами и IPTV-плеерами
    - `JSON` - полезен для передачи EPG на внешние серверы или для непосредственного использования в веб-приложении. Например, он может быть встроен в веб-сайт
- `Destination` - назначение для экспорта EPG:
    - `file://` - сохранить EPG в локальном файле. Например, при использовании `file:///tmp/test_channel.xml` будет хранить EPG в `/tmp` каталог с именем файла `test_channel.xml`
    - `http://` - отправка EPG с помощью HTTP POST-запроса. На стороне сервера для обработки полученного запроса требуется приложение, например, EPG Aggregator
- `Codepage` - декодирование текста из полученных EIT-пакетов с использованием заданной кодовой страницы. Хранимый текст всегда кодируется в формате UTF-8

## Агрегатор EPG[](https://help.cesbo.com/astra/admin-guide/stream/epg#epg-aggregator)

EPG Aggregator - это скрипт для Astra, позволяющий получать EPG со многих серверов и сохранять его в единый файл XMLTV.

### Установка

Чтобы установить скрипт, скачайте его и сохраните на сервере. Это можно сделать с помощью `curl` команда на сервере:

```
curl -Lo /etc/astra/epg-aggregator.lua https://cdn.cesbo.com/astra/scripts/epg-aggregator/epg-aggregator.lua
```

### Запуск скрипта с помощью Systemd

Для автоматического запуска скрипта можно добавить его в systemd.

1. Загрузить файл конфигурации: [https://cdn.cesbo.com/astra/scripts/epg-aggregator/astra-epg.service](https://cdn.cesbo.com/astra/scripts/epg-aggregator/astra-epg.service)
2. В этом файле можно настроить аргументы командной строки
3. Сохраните файл на своем сервере по адресу `/etc/systemd/system/astra-epg.service`
4. Запустить скрипт: `systemctl start astra-epg`
5. Включить автозапуск: `systemctl enable astra-epg`

Аргументы командной строки:

- `-o /tmp/epg.xml` - полный путь для хранения сгенерированного файла XMLTV
- `-p 5000` -порт для приема запросов от Astra
- `–daemon` - запуск в качестве демона
- `–interval SEC` - интервал сохранения EPG в файл. по умолчанию: 60 секунд
- `–stalker` - заменить тег `<sub-title>` на `<desc>` для промежуточного программного обеспечения Stalker/Ministra

Скрипт готов к приему запросов от Astra

### Настройка Astra для агрегатора EPG

В настройках потока на вкладке "EPG" настройте экспорт EPG:

- `Format` - набор `JSON`
- `Destination` - набор `http://EPG_agregator_IP:5000`

Файл XMLTV с собранными данными будет расположен по пути: `/tmp/epg.xml`. Также вы можете загрузить XMLTV с сайта http://EPG\_agregator\_IP:5000/epg.xml или добавить этот URL в клиентское приложение.

### Ночной перезапуск агрегатора EPG

В некоторых случаях может потребоваться перезапуск EPG Aggregator, лучше делать это в ночное время. Это можно сделать с помощью системного планировщика - cron. Откройте конфигурацию cron:

```
sudo crontab -e
```

и добавить строку в файл:

```
0 4 * * * systemctl restart astra-epg
```

Сохраните изменения в cron. Коллектор будет перезапускаться каждую ночь в 4:00
