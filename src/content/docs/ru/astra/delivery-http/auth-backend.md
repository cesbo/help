---
title: "Auth: HTTP Backend"
sidebar:
    order: 22
---

Разрешение через HTTP Backend позволяет использовать вашу существующую систему управления пользователями (Middleware) для контроля доступа к вашим потокам. Вместо управления пользователями в Astra, вы можете подключиться к вашей текущей платформе, такой как Ministra, IPTVportal или кастомная система.

## Как это работает

![HTTP Backend](https://cdn.cesbo.com/help/astra/delivery/http-hls/auth/http-backend.svg)

1. **Пользователь запрашивает канал**: Плеер зрителя отправляет запрос с их токеном или учетными данными
2. **Astra запрашивает ваш Middleware**: Astra пересылает детали запроса в вашу систему управления пользователями
3. **Middleware проверяет разрешения**: Ваша система проверяет, может ли пользователь получить доступ к этому каналу
4. **Доступ предоставляется или отклоняется**: Если доступ разрешен, Astra передает контент; если нет, доступ блокируется

## Настройка

Перейдите в `Настройки` → `HTTP Auth` в Astra. Выберите "Тип Backend" и укажите "Адрес Backend" для вашей системы.

### Ministra/Stalker

Адрес Backend:

```
http://example.com/stalker_portal
```

В вашей админ-панели Ministra/Stalker включите `Temporary URL` → `Flussonic support`

### IPTVportal

**Для облачной платформы:**

```
https://go.iptvportal.cloud
```

**Для локальной установки:** Используйте адрес вашего сервера (например, `http://your-server.com`)

В настройках портала откройте меню `Ключи` и создайте новый ключ:

- `Name`: Astra
- `Algorithm`: ARESSTREAM
- `Mode`: SM
- `Key Length`: 1472 bit
- `Update Rate`: 1:00:00

В настройках канала портала:

- `Auth`: arescrypt
- `Encoded`: включено
- `Key`: Astra

### Microimpulse Smarty

Адрес Backend:

```
http://example.com
```

### HTTP Request

Создайте вашу собственную систему аутентификации, выбрав `HTTP Request` как тип Backend и указав ваш пользовательский URL-адрес конечной точки.

Когда пользователь запрашивает доступ, Astra отправляет GET-запрос к вашей конечной точке с:

- Параметры запроса: Все параметры из изначального запроса пользователя
- HTTP-заголовки с деталями сессии:
    - `X-Session-ID`: уникальный номер сессии
    - `X-Channel-ID`: уникальный идентификатор канала
    - `X-Real-IP`: IP-адрес клиента
    - `X-Real-Path`: путь запроса клиента
    - `X-Real-UA`: User-Agent клиента
    - `X-Real-Host`: Host запроса клиента

Ваш сервер может ответить:

- `HTTP 200`: Доступ разрешен
- `HTTP 403/401`: Доступ запрещен
- Заголовок `X-Session-Name` - Имя пользователя (опционально)

**Пример работы:**

1. Ваш backend: `https://auth.example.com/check`
2. Пользователь запрашивает: `https://live.example.com/play/a001/index.m3u8?token=123`
3. Astra вызывает: `https://auth.example.com/check?token=123`
4. Включает заголовки: `X-Real-Path: /play/a001/index.m3u8` и другие детали запроса

## Важно: Поведение по умолчанию

Если ваш backend недоступен, Astra позволяет доступ по умолчанию. Это предотвращает сбои в вашем сервисе, если у вашего сервера аутентификации проблемы, но это значит, что пользователи получат бесплатный доступ в период сбоев.

## Устранение проблем

### Пользователи получают бесплатный доступ

Если пользователи могут смотреть каналы без оплаты, возможно, ваш backend недоступен. Проверьте подключение к вашему backend:

```sh
curl -v "https://auth.example.com/check"
```

Замените URL на фактический адрес вашего backend из настроек Astra.

**Общие проблемы:**

- `Connection refused`: Сервер backend не работает
- Запрос зависает: Проблемы с сетевым подключением
- Неправильный URL: Проверьте адрес вашего backend в настройках

### Пользователи не могут получить доступ к платным каналам

Если легитимные пользователи блокируются:

1. Проверьте логи вашего backend: Ищите ошибки аутентификации
2. Проверьте коды ответов: Ваш backend должен возвращать HTTP 200 для валидных пользователей
3. Протестируйте вручную: Используйте curl с валидным токеном для тестирования вашей конечной точки