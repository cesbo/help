---
title: Integration Astra with Zabbix
date: 2023-03-04
sidebar:
    order: 4
---

import { Steps } from '@astrojs/starlight/components'

Zabbix — это платформа с открытым исходным кодом для мониторинга сетевых сервисов, серверов и приложений. Она может быть интегрирована с Astra для мониторинга потоков (Streams) и DVB адаптеров.

:::note
Доступно для версий Astra, выпущенных после 2021-05-11
:::

## Установка Zabbix Server

Zabbix может быть установлен как на выделенном сервере, так и на сервере с Astra

<Steps>

1. Перейдите на сайт https://zabbix.com

1. Выберите версию Zabbix

1. Выберите вашу операционную систему

1. Следуйте инструкциям по установке

</Steps>

Подробную информацию можно найти в [руководствах Zabbix](https://www.zabbix.com/manuals)

## Установка Zabbix Agent

Установите Zabbix Agent на сервер с Astra.

<Steps>

1. Перейдите на сайт https://www.zabbix.com/download_agents

1. Выберите вашу операционную систему

1. Следуйте инструкциям по установке

</Steps>

Подробную информацию можно найти в [руководствах по Zabbix Agent](https://www.zabbix.com/documentation/current/manual/concepts/agent)

## Конфигурация Zabbix Agent

Прежде всего, необходимо настроить Zabbix Agent для разрешения входящих соединений от Zabbix Server. Откройте файл конфигурации агента, расположенный в `/etc/zabbix/zabbix_agentd.conf`, с помощью вашего любимого редактора.

1. Найдите опцию `Server=` и установите IP-адрес или имя хоста сервера с Zabbix Server;
1. Найдите опцию `UnsafeUserParameters=` или добавьте новую и установите значение `1`.

Сохраните файл.

Zabbix Agent получает всю информацию от Astra через скрипты, написанные на Python. Убедитесь, что на вашем сервере установлен Python3:

```sh
sudo apt install python3 python3-pip
```

для систем на базе RPM используйте `yum` вместо `apt`. Затем установите необходимую библиотеку для Python:

```sh
pip3 install requests
```

Скачайте скрипты для Zabbix Agent:

```sh
curl https://cdn.cesbo.com/astra/zabbix/agent.tar.gz | tar -zxC /opt
```

Скрипты будут сохранены в директории `/opt/zabbix_agent`. Скачать файл конфигурации сервиса для Zabbix Agent:

```sh
curl -o /etc/zabbix/zabbix_agentd.d/astra.conf https://cdn.cesbo.com/astra/zabbix/astra.conf
```

И наконец, перезапустите Zabbix Agent:

```sh
systemctl restart zabbix-agent
```

## Конфигурация Zabbix

### Установка шаблона Zabbix для Astra

Скачайте [шаблон](https://cdn.cesbo.com/astra/zabbix/zbx_astra.xml) на ваш компьютер и импортируйте этот файл в Zabbix:

В веб-интерфейсе Zabbix откройте `Configuration` → `Templates`, затем нажмите кнопку `Import` в верхнем правом углу. Нажмите `Browse` и выберите скачанный файл шаблона, затем нажмите кнопку `Import`. После успешного импорта вы увидите зеленое сообщение `Imported successfully`.

### Настройка шаблона

В веб-интерфейсе Zabbix откройте `Configuration` → `Templates`, затем выберите `Astra API monitoring` и откройте вкладку Macros. Заполните следующие значения:

- Первая строка: укажите пароль администратора для веб-интерфейса Astra
- Вторая строка: укажите имя пользователя администратора для веб-интерфейса Astra
- Последняя строка: порт веб-интерфейса Astra. Если у вас несколько процессов, укажите все порты через запятую. Например: `8000,8001,8002`

Нажмите кнопку `Update`, чтобы применить изменения

### Подключение Zabbix к Astra

В веб-интерфейсе Zabbix откройте Configuration → Hosts, затем нажмите `Create host` в верхнем правом углу. Заполните следующие поля:

- `Hostname` - любое имя сервера, на котором установлена Astra, например: Astra
- `Groups` - выберите `Cesbo_templates` или создайте новую группу
- `Interfaces` - нажмите добавить, выберите `Agent` и укажите IP-адрес или имя хоста сервера с Zabbix Agent

Откройте вкладку Templates и в поле `Link new templates` добавьте `Astra API monitoring`. Также, если вы хотите контролировать общее состояние системы, добавьте `Linux by Zabbix agent`.

Сохраните изменения. Примерно через 10 минут вы увидите графики и триггеры о состоянии каналов и адаптеров.

## Примеры графиков

![Каналы в Zabbix](https://cdn.cesbo.com/help/astra/monitoring/export/zabbix/zabbix-channel.png)

![DVB в Zabbix](https://cdn.cesbo.com/help/astra/monitoring/export/zabbix/zabbix-dvb.png)