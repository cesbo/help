---
title: "Stream: EPG Export Settings"
sidebar:
    order: 15
---

Настройка экспорта EPG для извлечения электронного программного гида из потока

![Stream: Форма настроек экспорта EPG](https://cdn.cesbo.com/help/astra/admin-guide/stream/epg.png)

- `XMLTV Channel ID`: используйте настраиваемый идентификатор канала вместо основного ID
- `Format`: формат экспорта EPG:
    - `XMLTV`: этот популярный формат используется для хранения и распространения EPG. XMLTV совместим с различным ПО и IPTV плеерами
    - `JSON`: полезен для отправки EPG на внешние серверы или для прямого использования в веб-приложении. Например, его можно встроить на веб-сайт
- `Destination`: место назначения для экспорта EPG:
    - `file://`: сохранить EPG в локальный файл. Например, при использовании `file:///tmp/test_channel.xml`, EPG будет сохранен в директорию `/tmp` с именем файла `test_channel.xml`
    - `http://`: отправка EPG с помощью HTTP POST запроса. На стороне сервера требуется приложение, которое будет обрабатывать полученные запросы, например, EPG Aggregator
- `Codepage`: декодировать текст из полученных пакетов EIT с использованием заданной кодировки. Сохраненный текст всегда кодируется в UTF-8

## EPG Aggregator

EPG Aggregator — это скрипт для Astra, который собирает EPG с многих серверов и сохраняет его в один файл XMLTV.

### Установка

Чтобы установить скрипт, скачайте его и сохраните на сервере. Это можно сделать с помощью команды `curl` на сервере:

```sh
curl -Lo /etc/astra/epg-aggregator.lua https://cdn.cesbo.com/astra/scripts/epg-aggregator/epg-aggregator.lua
```

### Запуск скрипта с помощью Systemd

Чтобы скрипт запускался автоматически, его можно добавить в systemd.

1. Скачайте файл конфигурации: https://cdn.cesbo.com/astra/scripts/epg-aggregator/astra-epg.service
2. В этом файле можно настроить аргументы командной строки
3. Сохраните файл на ваш сервер в `/etc/systemd/system/astra-epg.service`
4. Запустите скрипт: `systemctl start astra-epg`
5. Включите автозапуск: `systemctl enable astra-epg`

Аргументы командной строки:

- `-o /tmp/epg.xml`: полный путь для хранения сгенерированного файла XMLTV
- `-p 5000`: порт для получения запросов от Astra
- `–daemon`: запуск в режиме демона
- `–interval SEC`: интервал сохранения EPG в файл. По умолчанию: 60 секунд
- `–stalker`: заменить тег `<sub-title>` на `<desc>` для ПО Stalker/Ministra

Скрипт готов к получению запросов от Astra.

### Настройка Astra для EPG Aggregator

В настройках потока, на вкладке "EPG", настройте экспорт EPG:

- `Format`: установите `JSON`
- `Destination`: установите `http://EPG_aggregator_IP:5000`

Файл XMLTV с собранными данными будет находиться по пути: `/tmp/epg.xml`. Также, вы можете загрузить XMLTV с http://EPG_aggregator_IP:5000/epg.xml или добавить этот URL в клиентское приложение.

### Ежедневная перезагрузка EPG Aggregator

В некоторых случаях может потребоваться перезагрузка EPG Aggregator, лучше это делать ночью. Это можно выполнить с помощью планировщика задач - cron. Откройте конфигурацию cron:

```
sudo crontab -e
```

и добавьте строку в файл:

```
0 4 * * * systemctl restart astra-epg
```

Сохраните изменения в cron. Коллектор будет перезагружаться каждую ночь в 4:00.